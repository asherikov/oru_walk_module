<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>A sparse MPC solver for walking motion generation.: Architecture and operation</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">A sparse MPC solver for walking motion generation.
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.8.0 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">Architecture and operation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#pGraph">Connections between submodules</a></li>
<li class="level1"><a href="#pControlLoop">Control loop</a></li>
<li class="level1"><a href="#pControlThread">Control thread</a><ul><li class="level2"><a href="#pDCMsync">Synchronization with DCM</a></li>
<li class="level2"><a href="#pThreadPriority">Priority of the control thread</a></li>
</ul>
</li>
<li class="level1"><a href="#pFeedback">Feedback</a></li>
<li class="level1"><a href="#pIGM">Inverse kinematics</a></li>
</ul>
</div>
<div class="textblock"><h2><a class="anchor" id="pGraph"></a>
Connections between submodules</h2>
<div align="center">
<img src="dot_inline_dotgraph_1.png" alt="dot_inline_dotgraph_1.png" border="0" usemap="#dot_inline_dotgraph_1.map"/>
<map name="dot_inline_dotgraph_1.map" id="dot_inline_dotgraph_1.map"></map>
</div>
<p> <br/>
<br/>
</p>
<h2><a class="anchor" id="pControlLoop"></a>
Control loop</h2>
<p>A sequence diagram of one control loop: </p>
<div align="center">
<img src="msc_inline_mscgraph_1.png" alt="msc_inline_mscgraph_1" border="0" usemap="#msc_inline_mscgraph_1.map"/>
<map name="msc_inline_mscgraph_1.map" id="msc_inline_mscgraph_1.map"></map>
</div>
<p> The interconnection between DCM thread, DCM callback and control thread is explained in section <a class="el" href="pArch.html#pControlThread">Control thread</a>, this section also describes the parameters of the control thread.</p>
<p>Operations displayed on this diagram are described below. <br/>
<br/>
</p>
<h2><a class="anchor" id="pControlThread"></a>
Control thread</h2>
<p>We use a separate thread to control a robot, this thread is synchronized with DCM. The control sampling time using in this thread is 20 ms. The thread is spawned when the 'walk' command is received by the module.</p>
<p>For some time we have been using hook (callback) to ALMotion module. The main reason why we switched to a separate thread was the lack of synchronization between DCM and ALMotion threads. This is important since DCM updates joint angles in the memory, and there is no other way to get the values of the angles.</p>
<p>This is probably not a good solution, which would not work as well in future releases of firmware.</p>
<h3><a class="anchor" id="pDCMsync"></a>
Synchronization with DCM</h3>
<p>The DCM is activated each 10 ms. We register a callback function, which is called when DCM finishes its work. Thus the callback function is also executed each 10ms. The callback has a counter of executions, on each even execution (i.e. each 20 ms.) it wakes up the control thread using conditional variable -- a synchronization tool provided by the Boost.</p>
<h3><a class="anchor" id="pThreadPriority"></a>
Priority of the control thread</h3>
<p>The priority of the control thread plays a critical role, since sometimes it is not possible to complete all necessary computations in 20ms. using default priority.</p>
<p>We use SCHED_FIFO scheduling policy, the same as DCM thread uses. The priority is set to 65. Note, that NaoQi does not run with root privileges and it limits the possible changes of priorities. <br/>
<br/>
</p>
<h2><a class="anchor" id="pFeedback"></a>
Feedback</h2>
<p>There are two types of feedback.</p>
<p>The first one is shown on sequence diagram above. The position of center of mass, that is used as the initial position in the MPC solver, is corrected using the position of center of mass computed from the sensor data. The feedback is applied only if the difference between these positions is bigger than predefined threshold. Also, the error is multiplied by a gain (&lt; 1.0) before addition.</p>
<p>The second one is required to avoid jumps of center of mass, when the support foot is changed. In this case the position of new support foot is not the same as expected due to imprecision of movements. Therefore, we have to find the new position using sensors and change this position in the footstep pattern. It is also necessary to synchronize joint angles in the model of the robot with the joint angles obtained from sensors. <br/>
<br/>
</p>
<h2><a class="anchor" id="pIGM"></a>
Inverse kinematics</h2>
<p>We compute inverse kinematics and set joint angles twice in one control loop.</p>
<p>The first computation produces the joint angles that must be reached in one control sampling period, i.e. when the control thread is activated again. Since these joint angles are reached when the control loop is activated next time, the controllers have to have some commands to execute while the control loop works. The second solution is produced to keep controllers busy, it prevents jerky motions. The joint angles obtained in the second computation are expected to be reached in two control sampling periods. <br/>
<br/>
 </p>
</div></div><!-- contents -->


<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.0
</small></address>

</body>
</html>
